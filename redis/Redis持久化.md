Redis持久化
====
redis数据存在内存，提供持久化机制用于机器宕机|程序crash后redis数据恢复。
## 持久化机制
> 1.RDB  

对redis数据周期性或者指定时间间隔对数据集生成时间点快照。  
**特点：**  
```
- Save|shutdown|slave命令会触发  
- 适用冷备
- 默认5分钟生成一次快照
``` 
### RDB优势
```
a. RDB数据集中，代表某一时刻Redis里面的数据，非常时候做备份。
b. 数据恢复比AOF快
```
### RDB劣势
```
a. 数据完整性，如果宕机快照后面的5分钟数据会丢失；  
b. 数据集大时候，Redis fork()的子进程去生产快照可能比较耗时，Redis服务器可能暂停几十毫秒甚至1s去处理客户端。如果是秒杀系统肯定不行。
```

### RDB快照
默认配置中数据快照保存在**dump.rdb**二进制文件中，可以通过设置```save 10 1000```[10s内至少有1000Key有改动就自动保存数据集]来修改生成快照的策略。  

### 生成快照  

a. Redis调用fork()生成一个子进程；  
b. 子进程将数据写入到一个临时RDB文件中；  
c. 替换原始的RDB文件。

> 2.AOF [append only file]  

对每条写入操作命令作为日志以追加模式写入到日记文件中。  
特点：  
```
- 使用热备  
- 默认每秒同步
```
### AOF优势
```
a. 数据更加完整。Redis默认每秒同步数据集，每秒Redis会调用fsync进程，宕机发生数据不易丢失；  
```
### AOF劣势
```
a. AOF文件比RDB大
```
### 配置
```
1. appendfsync always     #每次数据修改写入AOF文件
2. appendfsync no         #不持久化
3. appendfsync everysec   #每秒同步 **默认配置推荐使用**
```
## RDB和AOF选择
一般情况，同时使用该两种持久化。单独使用RDB丢失数据更多；单独AOF，数据恢复没RDB快。